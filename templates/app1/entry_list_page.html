{% load el_pagination_tags %}

{% paginate 4 stories %}
{% csrf_token %}

{% for obj in stories %}
    {% if obj.id not in final_report %}
        {% if obj.id not in report_list %}
            <div id="story_id_{{ obj.id }}">
                {% if  obj.user.userprofile.image %}
                    <img src="{{ obj.user.userprofile.image.url }}" alt="{{ obj.user }}" width="50" height="50">
                {% else %}
                    <img src="/media/default-placeholder.png" class="img-circle" alt="{{ obj.user }}" width="50"
                         height="50">
                {% endif %}


                <a href="{% url 'user_profile' obj.user %}">{{ obj.user }}</a>

                <strong>{{ obj.member }}</strong> members.
                {#                        <h3>Debug : {{ obj.user.id }}</h3>#}
                {% load app1_extras %}
                <div id="follow{{ forloop.counter }}">
                    {% if not obj.user == request.user %}
                        {% pass_follower_list request.user obj.user.id forloop.counter %}
                        <button type="button" class="btn btn-danger"
                                onclick="ownreport({{ obj.id }},{{ obj.id }})">
                            Report
                        </button>
                        <button type="button" class="btn btn-danger"
                                onclick="favourite_place('{{ obj.story_page }}')">
                            Favourite
                        </button>
                        <button type="button" class="btn btn-danger"
                                onclick="not_favourite_place('{{ obj.story_page }}')">
                            Not favourite
                        </button>

                    {% endif %}

                </div>

                <div class="gp-div-post-full">

                    {% if obj.stories.all.exists %}
                        <div class="gp-slide-show">
                            <div class="gp-slide-shadow"></div>
                            <div id="storyCarousel{{ forloop.counter }}" class="carousel slide gp-carousel"
                                 data-ride="carousel">
                                <!-- Wrapper for slides -->

                                <div class="carousel-inner" role="listbox">

                                    {% for obj2 in  obj.stories.all %}
                                        <div class="item {% if forloop.first %}active{% endif %}">
                                            <img class="card-img-top gp-card-img" src="{{ obj2.file.url }}">
                                        </div>
                                    {% endfor %}

                                </div>
                                <!-- Left and right controls -->
                                <a class="left carousel-control" id="gp-carousel-control"
                                   href="#storyCarousel{{ forloop.counter }}"
                                   role="button"
                                   data-slide="prev">
                                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="right carousel-control" id="gp-carousel-control"
                                   href="#storyCarousel{{ forloop.counter }}"
                                   role="button"
                                   data-slide="next">
                                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                            </div>
                        </div>
                        {#                    {% else %}#}
                        {#                        <p class="gp-post-no-image-text">No images shared by <strong>{{ obj.user }}</strong>.</p>#}
                    {% endif %}

                    <div class="gp-desc">
                        <h4 class="card-title">{{ obj.title_name }}</h4>
                        <p class="card-text-date">{{ obj.created_date }}</p>


                        <p class="card-budget"><strong>Budget:</strong> {{ obj.budget }}</p>
                        <p class="card-type"><strong>Type:</strong> {{ obj.type_name }}</p>
                        <p class="card-text">
                            {% if obj.des|length > 50 %}
                                {{ obj.des|linebreaks|safe|truncatewords:"50" }}
                                <a href="{% url 'story_detail' obj.id %}">Read Full Story</a>
                            {% else %}
                                {{ obj.des|linebreaks|safe }}
                            {% endif %}

                        </p>
                    </div>
                    <div class="gp-util-bar">
                        <div class="gp-div-half">
                            <a id="likes" data-id="{{ obj.id }}" class="gp-like-button">
                            <span id="gp-like-logo-{{ obj.id }}"
                                  class="glyphicon {% if obj.id in like_list %}glyphicon glyphicon-heart {% else %} glyphicon-heart-empty {% endif %}"></span>
                                <span id="gp-total-like-{{ obj.id }}">{{ obj.total_likes }}</span>
                            </a>
                        </div>
                        <div class="gp-div-half">
                            <a id="ts-share" data-id="{{ obj.id }}" class="gp-share"><span
                                    class="glyphicon glyphicon-share-alt"></span> Share</a>
                        </div>
                    </div>

                    <!-- Comment show start -->
                    <div class="gp-comment-group">
                        <div id="total_comments{{ forloop.parentloop.counter }}" class="gp-total-comments">
                            <a  onclick="toggleDiv(this,{{ forloop.counter }})" class="gp-flat-link">
                                <p>Total {{ obj.comments.count }} comments.</p>
                            </a>
                        </div>

                        <div id="{{ forloop.counter }}">
                            {% for comment in obj.comments.all %}
                                <div class="gp-comment">
                                    <p class="gp-username"><a
                                            href="{% url 'user_profile' comment.author.username %}">{{ comment.author.username }}</a>
                                    </p>
                                    <p class="gp-date">{{ comment.created_date }}</p>
                                    <p id="comment{{ comment.id }}" class="gp-content">{{ comment.text }}</p>

                                    {{ forloop.parentloop.counter }}
                                    {% if comment.id in comment_list %}
                                        <div id="comment_buttons{{ comment.id }}">
                                            <div class="bg-margin-top-10">
                                                <a class="btn btn-danger" id="delete_story_comment"
                                                   data-toggle="confirmation"
                                                   data-id1="{{ forloop.parentloop.counter }}"
                                                   data-id2="{{ comment.id }}">
                                                    Delete
                                                </a>

                                                <button class="btn btn-info" id="edit"
                                                        onclick="edit_comment( {{ forloop.parentloop.counter }}, {{ comment.id }})">
                                                    Edit
                                                </button>
                                            </div>
                                        </div>

                                        <div id="comment_edit_form_div{{ comment.id }}" style="display: none">
                                            <form id="comment_edit_form{{ comment.id }}">
                                                <input type="text" name="comment_edit"
                                                       id="comment_edit_text{{ comment.id }}"
                                                       value="{{ comment.text }}" class="form-control">
                                            </form>
                                        </div>
                                    {% endif %}

                                </div>
                            {% endfor %}
                        </div>
                        <!-- Comment show end -->


                        <!-- Adding a comment part start -->

                        <form id="add_comment{{ forloop.counter }}" data-id={{ obj.id }} method="POST"
                              class="gp-form-story-comment">
                            {% csrf_token %}
                            <div class="input-group">
                                <input class="form-control" type="text" id="text{{ forloop.counter }}"
                                       maxlength="1000" name="text" required>
                                <div class="input-group-btn">
                                    <button class="btn btn-default" onclick="commentDiv({{ forloop.counter }})"
                                            type="submit">
                                        <i class="glyphicon glyphicon-send"></i>
                                    </button>
                                </div>
                            </div>

                        </form>
                    </div>
                    <!-- Adding-Comment part end -->
                </div>
            </div>

        {% endif %}
    {% endif %}
{% endfor %}
{% show_more %}

{% block javascript_block %}

    <script>


        $(function () {
            $("a#ts-share").on('click', function () {

                var story_id = $(this).attr("data-id");

                console.log(story_id);

                var data = {
                    story_id: story_id,
                    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
                };

                $.post('{% url 'ajax_notify_followers' %}', data, function (data) {
                    console.log(data)
                });
            });
        });


        function ownreport(story_id, divid) {

            // alert(ques_ans)
            alert("Reported! you will not see this again :)")
            $("#story_id_" + divid).hide();
            //alert(story_id);
            $.ajax({
                url: '{% url 'own_report' %}',
                type: 'POST',
                data: {
                    story_id: story_id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function () {
                    //alert("Created a New Comment");
                    //load('index.html');
                }
            });

        }

        function edit_comment(divID, comment_id) {
            $("#comment_buttons" + comment_id).hide();
            $("#comment_edit_form_div" + comment_id).show();
            $("#comment" + comment_id).hide();
            $("#comment_edit_form" + comment_id).on('submit', function (event) {
                event.preventDefault();
                var element = $(this);
                element.off('submit');
                var text = $("#comment_edit_text" + comment_id).val();
                //alert(text);
                $.ajax({
                    url: '{% url 'comment_edit' %}',
                    type: 'POST',
                    data: {
                        comment_id: comment_id,
                        new_comment: text,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function () {
                        //alert("yoo yoo wassup?");
                        $("#comment_edit_form_div" + comment_id).hide();
                        $("#comment" + comment_id).show();
                        $("#comment_buttons" + comment_id).show();
                        $("#comment" + comment_id).text($("#comment_edit_text" + comment_id).val());
                    }
                });
            });

        }


        $('[data-toggle=confirmation]').confirmation({
            rootSelector: '[data-toggle=confirmation]'
            // other options
        });


        function del_comment(divId, CommentId) {
            //console.log(divId);
            $.ajax({
                url: '{% url 'comment_delete' %}',
                type: 'POST',
                data: {
                    comment_id: CommentId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function () {
                    // alert("Created a New Comment");
                   // console.log(divId);
                    //$("#total_comments"+divId).hide();
                    $("#" + divId).load(" #" + divId);
                }
            });

        }


        $("body").on("click", "#delete_story_comment", function () {
            var divID = $(this).attr('data-id1');
            var comment_id = $(this).attr('data-id2');
            del_comment(divID, comment_id);
        });



        function favourite_place(story_place) {

            // alert(ques_ans)
            //alert("Favourite!");
           // $("#story_id_" + divid).hide();
            //alert(story_place);
            $.ajax({
                url: '{% url 'favourite_place' %}',
                type: 'POST',
                data: {
                    story_place: story_place,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function () {
                    //alert("Created a New Comment");
                    //load('index.html');
                }
            });

        }
        function not_favourite_place(story_place) {

            // alert(ques_ans)
            //alert("Favourite!");
           // $("#story_id_" + divid).hide();
            //alert(story_place);
            $.ajax({
                url: '{% url 'not_favourite_place' %}',
                type: 'POST',
                data: {
                    story_place: story_place,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function () {
                    //alert("Created a New Comment");
                    //load('index.html');
                }
            });

        }
    </script>
{% endblock %}